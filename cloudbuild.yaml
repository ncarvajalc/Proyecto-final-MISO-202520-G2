# cloudbuild.yaml - Monorepo Microservices + Frontend en Cloud Run
options:
  substitutionOption: ALLOW_LOOSE
  logging: CLOUD_LOGGING_ONLY

substitutions:
  _PROJECT_ID: "the-respect-435301-u2"
  _REGION: "us-central1"
  _ARTIFACT_REPO: "monorepo-repo"
  _CLOUDSQL_INSTANCE: "the-respect-435301-u2:us-central1:monorepo-db"
  _VPC_CONNECTOR: "connector-1"
  _DB_NAME: "monorepo"

images:
  - 'us-central1-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/security-audit'
  - 'us-central1-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/purchases-suppliers'
  - 'us-central1-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/tracking'
  - 'us-central1-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/warehouse'
  - 'us-central1-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/salesforce'
  - 'us-central1-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/api-gateway'
  - 'us-central1-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/cliente-web'

steps:
# ================================================
# Construcci√≥n y push de cada microservicio
# ================================================

# --- SECURITY AUDIT ---
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'us-central1-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/security-audit:$SHORT_SHA', './backend/SecurityAndAudit']
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'us-central1-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/security-audit:$SHORT_SHA']

# --- PURCHASES SUPPLIERS ---
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'us-central1-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/purchases-suppliers:$SHORT_SHA', './backend/PurchasesAndSuppliers']
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'us-central1-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/purchases-suppliers:$SHORT_SHA']

# --- TRACKING ---
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'us-central1-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/tracking:$SHORT_SHA', './backend/Tracking']
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'us-central1-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/tracking:$SHORT_SHA']

# --- WAREHOUSE ---
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'us-central1-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/warehouse:$SHORT_SHA', './backend/Warehouse']
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'us-central1-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/warehouse:$SHORT_SHA']

# --- SALESFORCE ---
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'us-central1-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/salesforce:$SHORT_SHA', './backend/SalesForce']
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'us-central1-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/salesforce:$SHORT_SHA']

# --- API GATEWAY ---
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'us-central1-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/api-gateway:$SHORT_SHA', './api_gateway']
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'us-central1-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/api-gateway:$SHORT_SHA']

# --- CLIENTE WEB ---
- name: 'gcr.io/cloud-builders/docker'
  args: ['build', '-t', 'us-central1-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/cliente-web:$SHORT_SHA', './cliente_web']
- name: 'gcr.io/cloud-builders/docker'
  args: ['push', 'us-central1-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/cliente-web:$SHORT_SHA']

# ================================================
# Deploy en Cloud Run
# ================================================

- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  entrypoint: bash
  args:
    - -c
    - |
      for svc in security-audit purchases-suppliers tracking warehouse salesforce api-gateway cliente-web; do
        echo "Deploying $svc..."
        gcloud run deploy $svc \
          --image us-central1-docker.pkg.dev/${_PROJECT_ID}/${_ARTIFACT_REPO}/$svc:$SHORT_SHA \
          --platform managed \
          --region ${_REGION} \
          --allow-unauthenticated \
          --add-cloudsql-instances ${_CLOUDSQL_INSTANCE} \
          --vpc-connector ${_VPC_CONNECTOR} \
          --set-env-vars DB_NAME=${_DB_NAME} \
          --set-secrets DB_PASSWORD=db-password:latest \
          --memory=512Mi --cpu=1 --min-instances=0 --max-instances=3
      done
